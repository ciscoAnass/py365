import os
import sys
import re
import hashlib
import pefile
import binascii
import json
import base64
from typing import Dict, List, Optional
from colorama import init, Fore, Style

class MalwareAnalyzer:
    def __init__(self, file_path: str):
        self.file_path = file_path
        self.pe = None
        self.analysis_results = {}
        init(autoreset=True)

    def load_file(self) -> bool:
        try:
            self.pe = pefile.PE(self.file_path)
            return True
        except Exception as e:
            print(f"{Fore.RED}Error loading file: {e}")
            return False

    def calculate_hashes(self) -> Dict[str, str]:
        with open(self.file_path, 'rb') as f:
            data = f.read()
            md5 = hashlib.md5(data).hexdigest()
            sha1 = hashlib.sha1(data).hexdigest()
            sha256 = hashlib.sha256(data).hexdigest()
        
        return {
            'MD5': md5,
            'SHA1': sha1,
            'SHA256': sha256
        }

    def extract_imports(self) -> List[Dict[str, str]]:
        imports = []
        try:
            for entry in self.pe.DIRECTORY_ENTRY_IMPORT:
                dll_name = entry.dll.decode('utf-8', errors='ignore')
                for imp in entry.imports:
                    try:
                        func_name = imp.name.decode('utf-8', errors='ignore') if imp.name else 'N/A'
                        imports.append({
                            'DLL': dll_name,
                            'Function': func_name
                        })
                    except Exception:
                        pass
        except Exception:
            pass
        return imports

    def extract_strings(self, min_length: int = 4) -> List[str]:
        strings = []
        try:
            with open(self.file_path, 'rb') as f:
                content = f.read()
                string_pattern = rb'[^\x00-\x1F\x7F-\xFF]{%d,}' % min_length
                found_strings = re.findall(string_pattern, content)
                strings = [s.decode('utf-8', errors='ignore') for s in found_strings]
        except Exception:
            pass
        return strings

    def analyze_sections(self) -> List[Dict[str, str]]:
        sections = []
        try:
            for section in self.pe.sections:
                sections.append({
                    'Name': section.Name.decode('utf-8', errors='ignore').rstrip('\x00'),
                    'Virtual Size': hex(section.Misc_VirtualSize),
                    'Characteristics': hex(section.Characteristics)
                })
        except Exception:
            pass
        return sections

    def perform_analysis(self) -> Dict:
        if not self.load_file():
            return {}

        self.analysis_results = {
            'File Path': self.file_path,
            'Hashes': self.calculate_hashes(),
            'Imports': self.extract_imports(),
            'Strings': self.extract_strings(),
            'Sections': self.analyze_sections()
        }
        return self.analysis_results

    def generate_report(self) -> str:
        report = json.dumps(self.analysis_results, indent=2)
        return report

def main():
    if len(sys.argv) < 2:
        print(f"{Fore.RED}Usage: python malware_analyzer.py <file_path>")
        sys.exit(1)

    file_path = sys.argv[1]
    
    if not os.path.exists(file_path):
        print(f"{Fore.RED}File not found: {file_path}")
        sys.exit(1)

    analyzer = MalwareAnalyzer(file_path)
    results = analyzer.perform_analysis()
    
    print(f"{Fore.GREEN}Malware Static Analysis Report:\n")
    print(analyzer.generate_report())

if __name__ == '__main__':
    main()